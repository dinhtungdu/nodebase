var express = require('express');
var path = require('path');
var app = express();

var path = require('path');
var g = require(path.join(LIBS_DIR, 'global'));

var ADMIN_MODULR_DIR = path.join(ROOT_DIR, 'admin/modules/');

g.isAcp = true;
app.use(function (req, res, next) {
    if(req.session.userInfo.LEVEL < USER_LEVEL.ADMINISTRATOR)
        res.redirect('/login');
    else next();
});


app.get('/:mod_name?/:mod_action?/:mod_param_string([a-zA-Z0-9\-\_\/]+)?', function(req, res) {
    if(typeof req.params.mod_name != 'undefined')
        g.admin.module = req.params.mod_name;
    else {
        g.admin.module = 'dashboard';
    }

    if(typeof req.params.mod_action != 'undefined')
        g.admin.action = req.params.mod_action;
    else {
        g.admin.action = 'main';
    }

    var adminModule = require(ADMIN_MODULR_DIR + g.admin.module + '/' + g.admin.module + '.js')('admin***' + g.admin.module, req, res, app);
    adminModule[g.admin.action](req, res);
});

app.post('/:mod_name?/:mod_action?/:mod_param_string([a-zA-Z0-9\-\_\/]+)?', function(req, res) {
    tpl.is_admin = true;

    if(typeof req.params.mod_name != 'undefined')
        global.module.name = req.params.mod_name;
    else {
        global.module.name = 'dashboard';
    }
    tpl.working.module = global.module.name;

    if(typeof req.params.mod_action != 'undefined')
        global.module.action = req.params.mod_action;
    else {
        global.module.action = 'main';
    }

    var adminModule = require(ADMIN_MODULR_DIR + g.admin.module + '/' + g.admin.module + '.js')('admin***' + g.admin.module, req, res, app);
    adminModule[g.admin.action](req, res);
});
module.exports = app;