"use strict";

var path = require('path');
var moduleBase = require(path.join(LIBS_DIR, 'module'));
var userBase = require(path.join(LIBS_DIR, 'user'))({});
module.exports = function(moduleName, req, res) {
    var self = new moduleBase(moduleName, req, res);

    self.loginForm = function() {
        //self.addDependencies(path.join(__dirname, 'login.css'));
        var msgs = [];
        var fls = req.flash();
        for(var mt in fls) {
            var ms = fls[mt];
            for(var mi in ms) {
                msgs.push({
                    type: mt,
                    content: ms[mi]
                });
            }
        }
        self.render('login', {msg: msgs});
    };

    self.checkLogin = function() {
        var errors = [];
        if(typeof req.body.username == 'undefined' || req.body.username == '')
            errors.push('Bạn phải điền tên đăng nhập');
        if(typeof req.body.password == 'undefined' || req.body.password == '')
            errors.push('Bạn phải điền mật khẩu');

        if(errors.length == 0) {
            userBase.login(req, req.body.username, req.body.password, function (msg, user) {
                if(msg.type == 'success') {
                    req.flash('success', 'Chào mừng bạn');
                    if(typeof req.body.back_url != 'undefined' && req.body.back_url != '')
                        res.redirect(301, req.body.back_url);
                    else res.redirect(301, '/user');
                }
                else {
                    req.flash('error', msg.content);
                    res.redirect('/login');
                }
            });
        }
        else {
            req.flash('error', errors);
            res.redirect('/login');
        }
    };

    self.logout = function() {
        userBase.logout(req, function() {
            res.redirect('/login');
        });
    };
    return self;
};